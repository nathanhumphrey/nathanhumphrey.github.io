<!doctype html>
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics 
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-50453547-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-50453547-1');
    </script>-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Stack JavaScript Application Build Part 4 - Backend Database Access and Authentication</title>
    <meta name="Description" content="Part 4 of a series about how to build a full stack JavaScript application. This article is about database access and user authentication on the backend. The frontend implementation of user auth will be covered in phase 2 of Part 4.">
    <link rel="icon" type="image/png" href="/favicon.ico?2108987463f3bdd37020efde9541db90">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css?e28fe60021527125d42d09192150abbf">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Nathan Humphrey">
  </head>
  <body>
    <div class="container" id="top">
      <header class="page-header">
        <p class="home">
          <a href="/">nh</a>
        </p>
        <nav class="page-nav">
          <h2 class="visually-hidden">Main Navigation Menu</h2>
          <ul class="nav"><li class="nav-item"><a href="/">Home</a></li>
<li class="nav-item"><a href="/posts/">Blog</a></li>
<li class="nav-item"><a href="/about/">About</a></li></ul>
        </nav>
      </header>

      <main class="tmpl-post" >
        <h1>Full Stack JavaScript Application Build Part 4 - Backend Database Access and Authentication</h1>
<p class="meta time"><time datetime="2020-04-06T07:00:00.000Z">Monday, April 6, 2020</time></p>
<p class="meta author">by Nathan Humphrey</p>
<p class="meta tags">

    <a href="/tags/software/" class="tag">software</a>
    <a href="/tags/tutorial/" class="tag">tutorial</a>
    <a href="/tags/javascript/" class="tag">javascript</a>
    <a href="/tags/fullstack/" class="tag">fullstack</a>
    <a href="/tags/koa/" class="tag">koa</a>
    <a href="/tags/sequelize/" class="tag">sequelize</a>
    <a href="/tags/passport/" class="tag">passport</a>
</p>
<h2 id="introduction">Introduction <a class="direct-link" href="#introduction">#</a></h2>
<p>Welcome to Part 4: Phase 1 of the Full Stack Application series. Part 4 has been broken into two distinct phases, as the entire article had grown quite long. In this phase, we'll be adding database support and some basic user authentication to the application. Database support will be added via <a href="https://sequelize.org/">Sequelize ORM</a>, which will allow us to provision a testing database very easily, and provides a means to access different databases without much fuss. User authentication will be implemented via the <a href="http://www.passportjs.org/">Passport.js</a> library, which again, will allow for easy initial setup and the ability to update to other auth options very quickly if needed. Phase 2 will see the implementation of this new auth system in the frontend of the application.</p>
<p class="info">
    NOTE: Again, I feel it's warranted to state that the build is intended to provide you with a good base for developing full stack JavaScript applications, but you will need to do some additional learning in order to get this application really production-ready.
</p>
<p><strong><em>The final project source can be found in this <a href="https://github.com/nathanhumphrey/simple-isomorphic-app/tree/database">GitHub repo</a></em></strong></p>
<h3 id="roadmap">Roadmap <a class="direct-link" href="#roadmap">#</a></h3>
<p>The build is divided into a six-part series:</p>
<ol>
<li><a href="/posts/2020-02-06-full-stack-javascript-app-build-pt-1/">Routes and pages</a></li>
<li><a href="/posts/2020-02-12-full-stack-javascript-app-pt-2/">Building components</a></li>
<li><a href="/posts/2020-03-24-full-stack-javascript-app-pt-3/">Styling components</a></li>
<li>Database access and authentication
<ol>
<li><a href="/posts/2020-04-06-full-stack-javascript-app-pt-4-phase1/">Backend implementation</a> ‚áê you are here</li>
<li><s>Frontend implementation</s> (coming soon)</li>
</ol>
</li>
<li><s>Protecting against CSRF attacks</s> (coming soon)</li>
<li><s>Production bundling</s> (coming soon)</li>
</ol>
<h2 id="creating-the-database-with-sequelize">Creating the database with Sequelize <a class="direct-link" href="#creating-the-database-with-sequelize">#</a></h2>
<p>What is Sequelize? The website tells us exactly what we're dealing with:</p>
<p><q>Sequelize is a promise-based Node.js ORM for Postgres, MySQL, MariaDB, SQLite and Microsoft SQL Server. It features solid transaction support, relations, eager and lazy loading, read replication and more.</q> <cite>-- <a href="https://sequelize.org/v5/">Sequelize website</a></cite></p>
<p>Couldn't have said it better myself! Using Sequelize will allow us to get up and running quickly, and without the need for directly accessing and configuring a database for development. There are many online discussions about why you should or shouldn't choose an ORM for your project, and I'm not married to either position. For this walkthrough, it allows us to move quickly without sacrificing time for discussions that are out of scope for what I want to do here.</p>
<h3 id="install-sequelize">Install Sequelize <a class="direct-link" href="#install-sequelize">#</a></h3>
<p>Install Sequelize for use in our application:</p>
<p><code class="term">npm i sequelize sequelize-cli</code></p>
<p>Now we can configure Sequelize to create a scaffold for database access. Create a <code>.sequelizerc</code> file in the project root directory. This file will be used to configure the initial setup for Sequelize in our project. There are four options that we can set:</p>
<ul>
<li><code>config</code> - defines where Sequelize will store and look for its configuration file</li>
<li><code>models-path</code> - defines where model files will be stored (also an index.js file that exports any models that have been created)</li>
<li><code>seeders-path</code> - defines where seeder files (basically initial data insert queries) will be stored</li>
<li><code>migrations-path</code> - defines where migration files (database creation and association queries) will be stored</li>
</ul>
<p>For our purposes, we won't be using any seeders, but we'll keep the configuration setting for reference purposes. All directories and files will be contained in the <code>src/db/</code> directory for the application.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token string">'config'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/db'</span><span class="token punctuation">,</span> <span class="token string">'database.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">'models-path'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/db'</span><span class="token punctuation">,</span> <span class="token string">'models'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">'seeders-path'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/db'</span><span class="token punctuation">,</span> <span class="token string">'seeders'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token string">'migrations-path'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/db'</span><span class="token punctuation">,</span> <span class="token string">'migrations'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p class="caption">.sequelizerc - create the sequelize configuration file</p>
<h3 id="sequelize-initialization">Sequelize initialization <a class="direct-link" href="#sequelize-initialization">#</a></h3>
<p>Run the following command to initialize Sequelize:</p>
<p><code class="term">npx sequelize-cli init</code></p>
<p>Once the command completes, you will have a new <code>src/db/</code> directory with several child directories and the <code>database.js</code> file, which will look the like the following:</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token property">"development"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"database"</span><span class="token operator">:</span> <span class="token string">"database_development"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"dialect"</span><span class="token operator">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"operatorsAliases"</span><span class="token operator">:</span> <span class="token boolean">false</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"test"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"database"</span><span class="token operator">:</span> <span class="token string">"database_test"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"dialect"</span><span class="token operator">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"operatorsAliases"</span><span class="token operator">:</span> <span class="token boolean">false</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token property">"production"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"database"</span><span class="token operator">:</span> <span class="token string">"database_production"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"dialect"</span><span class="token operator">:</span> <span class="token string">"mysql"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token property">"operatorsAliases"</span><span class="token operator">:</span> <span class="token boolean">false</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p class="caption">src/db/datatase.js - the default Sequelize database config file</p>
<p>What you might notice is that <code>database.js</code> isn't JavaScript but rather JSON, which is the default format. We will make some modifications to this file so that it is valid JavaScript and also supports our development SQLite (<a href="https://www.sqlite.org/index.html">a small, fast, self-contained, high-reliability, full-featured, SQL database engine</a>) database in a moment, but let's have a look at what's in the file first.</p>
<p>The <code>database.js</code> file contains three pretty self-explanatory configuration options:</p>
<ul>
<li>development - development database settings</li>
<li>test -  test database settings (should closely mirror your production database for final testing before deployment)</li>
<li>production - production database settings</li>
</ul>
<p>We won't worry about testing or deployment at this stage, so we'll update the file to support our development database only. Update <code>database.js</code> with the following code, which will define the dialect for SQLite and create the database file in a new <code>tmp/</code> directory. First, create the new <code>tmp/</code> under the project root and then update <code>database.js</code>:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  development<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    storage<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../tmp/test.sqlite'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    dialect<span class="token operator">:</span> <span class="token string">'sqlite'</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/db/datatase.js - updated database.js to support only our dev db</p>
<p>You might be saying to yourself, &quot;but we don't have a <code>test.sqlite</code> database file in the tmp directory we just made&quot;, and you're right! We have to create the database before it can be used. We could manually create the database with the <a href="https://www.sqlite.org/download.html">sqlite</a> program and then enter all the required DML statements for tables and initial data, but we don't need to! We can use Sequelize migrations to do that heavy lifting for us. The best part of utilizing Sequelize migrations is that you only have to create the migrations once. Still, you can use them to create and initialize any of the databases that Sequelize supports (e.g. PostgreSQL, MySQL, SQLite, etc.), neat!</p>
<h3 id="migrations">Migrations <a class="direct-link" href="#migrations">#</a></h3>
<p><a href="https://sequelize.org/v5/manual/migrations.html">Migrations</a> allow us to perform any necessary database transition tasks (e.g. create tables, create associations, insert data, etc.) on a database, and also the power to undo those tasks. We don't need much for our application at the moment, just a table to store our user data. The <code>sequelize-cli</code> gives us the ability to create our application User model and the Users table in our database via a migration in our project.</p>
<p class="info">
NOTE: the next couple of steps are essentially the same as what's presented on the Sequelize migration documentation page. Creating a user is a pretty standard task.
</p>
<p>First, let's create the User model:</p>
<p><code class="term">npx sequelize-cli model:generate --name User --attributes firstName:string,lastName:string,email:string,passwordHash:string</code></p>
<p>The previous command will create a new <code>user.js</code> file in <code>src/db/models/</code> and a <code>XXXXXXXXXXXXXX-create-user.js</code> in <code>src/db/migrations/</code>. I've decided to store only a user's first name, last name, email address, and a password hash (it's not good practice to store plain text passwords). The effects of the command have no effect on the actual database; for that, we'll need to run the migration. Before we run the migration, let's take a look at these two new files.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// src/db/models/user.js</span></span><br><span class="highlight-line"><span class="token string">'use strict'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    firstName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    lastName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    email<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    passwordHash<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// associations can be defined here</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> User<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/db/models/user.js - auto-generated user model file</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// src/db/migrations/XXXXXXXXXXXXXX-create-user.js</span></span><br><span class="highlight-line"><span class="token string">'use strict'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">INTEGER</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      firstName<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      lastName<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      email<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      passwordHash<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      createdAt<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      updatedAt<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">DATE</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token function-variable function">down</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/db/migrations/XXXXXXXXXXXXXX-create-user.js - auto-generated user migration file</p>
<p>You'll notice some variance between the two files, namely that the migration file defines additional fields to the ones we specified. These default fields are:</p>
<ul>
<li><code>id</code> - default primary key field added by Sequelize (auto incremented integer)</li>
<li><code>createdAt</code> - the time at which the model was originally created in the database</li>
<li><code>updatedAt</code> - the time at which the model was last updated in the database</li>
</ul>
<p>The two timestamp fields are managed by Sequelize, so we won't have to manage them in our application.</p>
<p class="info">
NOTE: The timestamp fields can be disabled or individually selected if desired. See the <a href="https://sequelize.org/master/manual/model-basics.html">Sequelize model</a> docs for more.
</p>
<p>For the most part, the field definitions are fine but we'll want to make a few small updates:</p>
<ul>
<li>I like to use <a href="https://tools.ietf.org/html/rfc4122">UUID</a>s for the id value, so we'll update that (Sequelize has good <a href="https://sequelize.org/master/manual/model-basics.html#uuids">support for UUIDs</a>)</li>
<li>The email for each user should be unique and required</li>
<li>The password hash shoule be required</li>
</ul>
<p>Finally, in addition to the two field updates, we'll create two additional 'class' methods for our User model to generate password hash values and to check password hash values (i.e. authenticate a user).</p>
<ul>
<li><code>generatePasswordHash</code> - this function will just create and return a bcrypt hash for a password</li>
<li><code>authenticate</code> - this function will find a user by their email and compare the stored hash with a passed in password</li>
</ul>
<p>As previously mentioned, it's not good practice to store plain text passwords in a database, so we'll install the <a href="https://www.npmjs.com/package/bcryptjs">bcryptjs</a> library to hash our user passwords:</p>
<p><code class="term">npm i bcryptjs</code></p>
<p class="info">
NOTE: If you'd like to make use of async/await in place of the promise .then() call I've used below, you will need to make use of the <code>@babel/plugin-transform-runtime</code> <a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime">plugin</a>.
</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// src/db/models/user.js</span></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> bcrypt <span class="token keyword">from</span> <span class="token string">'bcryptjs'</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">sequelize<span class="token punctuation">,</span> DataTypes</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span></span><br><span class="highlight-line">    <span class="token string">'User'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">      id<span class="token operator">:</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        defaultValue<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">UUIDV4</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">,</span></mark><br><span class="highlight-line">      firstName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      lastName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span></span><br><mark class="highlight-line highlight-line-active">      email<span class="token operator">:</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">      passwordHash<span class="token operator">:</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span></mark><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  </span><br><span class="highlight-line">  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token parameter">models</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// associations can be defined here</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  </span><br><mark class="highlight-line highlight-line-active">  User<span class="token punctuation">.</span><span class="token function-variable function">generatePasswordHash</span> <span class="token operator">=</span> <span class="token parameter">password</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">  User<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">return</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> email <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">&amp;&amp;</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>passwordHash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">          <span class="token keyword">return</span> user<span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> err<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span><span class="token punctuation">;</span></mark><br><span class="highlight-line">  <span class="token keyword">return</span> User<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/db/models/user.js - updated user model file</p>
<p>For the migration file, we only need to make the updates for the <code>id</code> and <code>email</code> fields:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// src/db/migrations/XXXXXXXXXXXXXX-create-user.js</span></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></mark><br><span class="highlight-line">  <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span><br><mark class="highlight-line highlight-line-active">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">UUID</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        defaultValue<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">UUIDV4</span></mark><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token operator">...</span></span><br><mark class="highlight-line highlight-line-active">      email<span class="token operator">:</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        type<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">,</span></mark><br><span class="highlight-line">      <span class="token operator">...</span></span></code></pre>
<p class="caption">src/db/migrations/XXXXXXXXXXXXXX-create-user.js - updated user migration file</p>
<p>We're now ready to migrate the database.</p>
<h3 id="migrate-the-database">Migrate the database <a class="direct-link" href="#migrate-the-database">#</a></h3>
<p>Before Sequelize can create our SQLite database, we need to install the corresponding SQLite npm package:</p>
<p><code class="term">npm i sqlite3</code></p>
<p>After the install completes, run the following command to run our migration:</p>
<p><code class="term">npx sequelize-cli db:migrate</code></p>
<p>You should be greeted with an error, and that's because the <code>db:migrate</code> command requires that the file already exists; it can't create the file for us. Luckily, we can use JavaScript to programmatically create the file using Sequelize's <code>sync()</code> method.</p>
<p class="info">
NOTE: <code>sequelize-cli</code> can create databases with the <code>db:create</code> command, but SQLite databases are not supported. With SQLite, each database is a file on the filesystem, which is different from other RDBMS servers that support the creation of multiple databases (once the server itself is installed of course).
</p>
<p>Sequelize provides a <code>sync()</code> method that can be used to create the required database file for us. The method accepts a <code>force</code> option, that will overwrite any existing database at the specified configuration. We can update our <code>src/server/index.js</code> to make use of this method when we fire up the server.</p>
<p class="warn">
WARN: the <code>sync({force: true})</code> method with <code>force: true</code> option will wipe out your database on every call (i.e. drop and re-create all tables), so any inserts, updates, etc. that have been carried out on the tables in our models will be lost. Use the <code>force: true</code> option with caution.
</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">...</span></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'../db/models/index'</span><span class="token punctuation">;</span> <span class="token comment">// Requiring our models for syncing</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token operator">...</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">db<span class="token punctuation">.</span>sequelize<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> force<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><span class="highlight-line">  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server listening on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark></code></pre>
<p class="caption">src/server/index.js - implement database access for the server</p>
<p>You should now see that our <code>test.sqlite</code> file (database) has been created in the <code>tmp/</code> directory. You could test that everything worked out as planned by downloading the sqlite executable (linked to earlier) and connecting to the database, but I'll leave that as an exercise for you to carry out on your own (should you feel so inclined). At this point, if you were to re-run the <code>db:migrate</code> command from earlier (adding a flag for ES module support), there should be no error, and everything should work fine. So, we've got database access, but now we need to make use of it.</p>
<h2 id="user-authentication-with-passport.js">User Authentication with Passport.js <a class="direct-link" href="#user-authentication-with-passport.js">#</a></h2>
<p>The whole point of adding database access was so that we could add user authentication and protected routes to our application. The Passport library makes it easy to authenticate users in your node application. By default, Passport is designed to work with any Express-based web application, but there is a <a href="https://www.npmjs.com/package/koa-passport">koa-passport</a> package that allows the library to work with Koa too. Passport allows you to authenticate users via a large number of supported strategies, from local (typical username/password logins) to social (e.g. facebook, Google, etc.). If you need support for a platform that doesn't already have a strategy, you can create your own!</p>
<p>Moving along, achieving our authentication and protection goals will require a little reworking of our current application, but not too much. The tasks we'll need to undertake are:</p>
<ul>
<li>Sign up new users</li>
<li>Allow users to sign in to the application</li>
<li>Protect desired routes from unauthorized access</li>
<li>Allow users to sign out of the application</li>
</ul>
<p>Let's get it!</p>
<h3 id="support-server-side-api-routes">Support server-side api routes <a class="direct-link" href="#support-server-side-api-routes">#</a></h3>
<p>We are currently diverting all routes to the <code>renderReactApp</code> middleware, which won't work now that we will have some dedicated server-side routes that don't require a rendered response. We can achieve the separation of server routes from client routes by creating a <code>src/server/routes.js</code> file to specifically handle only server-side routes. An example route would like the following:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">  <span class="token punctuation">{</span></span><br><span class="highlight-line">    path<span class="token operator">:</span> <span class="token string">'/some-path'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    middleware<span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">      <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token comment">// required middleware code here</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/server/routes.js - api routes file</p>
<p>In the example, we can see that we don't need quite the same level of detail that was used for our application routes. For api routes, we will include the following:</p>
<ul>
<li><code>path</code> - the desired path to serve</li>
<li><code>method</code> - the HTTP method to serve</li>
<li><code>middleware</code> - an array of middleware that should be applied to the matched route (we'll see why I've chosen an array soon)</li>
</ul>
<p>To allow the server to differentiate between application and api routes, we can create our api router with an <code>/api</code> prefix. The api router's prefix will then match incoming request URLs that begin with <code>/api</code>. Our api router setup also makes use of the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">spread operator</a> for middleware, to ensure that multiple middleware can be run (middleware is setup as an array in our api <code>routes.js</code> file).</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">...</span></span><br><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> routes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../app/routes'</span><span class="token punctuation">;</span> <span class="token comment">// defined application routes</span></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> <span class="token punctuation">{</span> apiRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./routes'</span><span class="token punctuation">;</span> <span class="token comment">// defined application routes</span></mark><br><span class="highlight-line"><span class="token operator">...</span></span><br><span class="highlight-line"><span class="token comment">// create the app router</span></span><br><span class="highlight-line"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token comment">// create the api router</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token keyword">const</span> apiRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">  prefix<span class="token operator">:</span> <span class="token string">'/api'</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// define route(s)</span></span><br><span class="highlight-line">routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  router<span class="token punctuation">[</span>route<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> renderReactApp<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token comment">// define api route(s)</span></mark><br><mark class="highlight-line highlight-line-active">apiRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">  router<span class="token punctuation">[</span>route<span class="token punctuation">.</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token operator">...</span>route<span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// create koa webpack middleware</span></span><br><span class="highlight-line"><span class="token function">koaWebpack</span><span class="token punctuation">(</span><span class="token punctuation">{</span> compiler <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  app</span><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>apiRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>apiRouter<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></mark><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">koaStatic</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/server/index.js - implement api routes</p>
<p>We are almost ready to define the actual routes for our api, all that's left is to add support for authenticating our users.</p>
<h3 id="install-passport-and-a-local-strategy">Install Passport and a local strategy <a class="direct-link" href="#install-passport-and-a-local-strategy">#</a></h3>
<p>Let's install the koa-flavoured package for passport to get started:</p>
<p><code class="term">npm i koa-passport</code></p>
<p>Next, we will create a new <code>src/server/user-auth.js</code> file to hold code related to authenticationg a user (i.e. the default passport stuff). A typical passport requires you to define three things:</p>
<ul>
<li>a method for serializing a user (<code>passport.serializeUser()</code>)</li>
<li>a method for deserializing a user (<code>passport.deserializeUser()</code>)</li>
<li>a method for configuring a strategy (<code>passport.use()</code>)</li>
</ul>
<p>The starter code for <code>user-auth.js</code> follows:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">import</span> passport <span class="token keyword">from</span> <span class="token string">'koa-passport'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'../db/models.js'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/server/user-auth.js - begin support for user authentication</p>
<p>As you can see, serializing and deserializing the user is pretty straightforward. When serializing a user, all we need to store is the user's id, as it can be used to find any unique user in the database. The deserialization method accepts the stored id and then returns the associated user object from the database. Simple.</p>
<h4 id="configure-the-local-strategy">Configure the local strategy <a class="direct-link" href="#configure-the-local-strategy">#</a></h4>
<p>The final thing to add to <code>user-auth.js</code> is the desired <a href="http://www.passportjs.org/packages/passport-local/">local strategy</a>. Install the package and then add the final method to the file:</p>
<p><code class="term">npm i passport-local</code></p>
<p class="info">
NOTE: In this application, I've decided to use the email field rather than the default username. By passing the update as an option to Passport, we can define any field as the equivalent of username.
</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">import</span> passport <span class="token keyword">from</span> <span class="token string">'koa-passport'</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy <span class="token keyword">as</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'../db/models'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> usernameField<span class="token operator">:</span> <span class="token string">'email'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line">passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token keyword">new</span> <span class="token class-name">LocalStrategy</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    db<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">          <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">          <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">)</span><span class="token punctuation">;</span></mark></code></pre>
<p class="caption">src/server/user-auth.js - updated with configured local strategy</p>
<p>We've configured our strategy to make use of the <code>User.authenticate()</code> method we defined in <code>src/db/models/user.js</code> earlier. Either we find a user with the supplied email and a password hash that matches the incoming password's hash, or we don't. Regardless of whether authentication is successful or not, we call the <code>done</code> callback as per the <a href="http://www.passportjs.org/docs/configure/">Passport docs</a>.</p>
<h4 id="implement-passport-in-our-server">Implement passport in our server <a class="direct-link" href="#implement-passport-in-our-server">#</a></h4>
<p>The final steps required for our Passport implementation are to setup <a href="https://www.npmjs.com/package/koa-session">session support</a> and a <a href="https://www.npmjs.com/package/koa-bodyparser">body-parser</a> to grab data out of incoming requests. Start by installing the following packages:</p>
<p><code class="term">npm i koa-session koa-bodyparser</code></p>
<p>Then, update <code>src/server/index.js</code> with the implemenation of these packages so we can begin creating our route middleware:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">...</span></span><br><span class="highlight-line"><span class="token keyword">import</span> db <span class="token keyword">from</span> <span class="token string">'../db/models/index'</span><span class="token punctuation">;</span> <span class="token comment">// Requiring our models for syncing</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> session <span class="token keyword">from</span> <span class="token string">'koa-session'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> passport <span class="token keyword">from</span> <span class="token string">'koa-passport'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> bodyParser <span class="token keyword">from</span> <span class="token string">'koa-bodyparser'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token keyword">import</span> <span class="token string">'./user-auth.js'</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token comment">// create the app server</span></span><br><span class="highlight-line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token comment">// sessions</span></mark><br><mark class="highlight-line highlight-line-active">app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'s3cur3s3cr3t'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active"><span class="token comment">// body parser</span></mark><br><mark class="highlight-line highlight-line-active">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active"><span class="token comment">// authentication</span></mark><br><mark class="highlight-line highlight-line-active">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p class="caption">src/server/index.js - implemented authentication support and api routes</p>
<h3 id="complete-the-api-route-middleware">Complete the api route middleware <a class="direct-link" href="#complete-the-api-route-middleware">#</a></h3>
<p>As mentioned earlier, the current application requires only a few routes:</p>
<ul>
<li>a route to sign up (create) a new user</li>
<li>a route to allow a user to sign in</li>
<li>a route to allow a user to sign out</li>
<li>a route to retrieve a user's profile details</li>
</ul>
<h4 id="signup-new-user-route">Signup new user route <a class="direct-link" href="#signup-new-user-route">#</a></h4>
<p>To this point, we've been able to avoid using async/await syntax in our application, which isn't a necessity, it just wasn't necessary. But now that we need to define our own Koa middleware, we're going to need async/await support. This can be achieved easily enough by updating our main <code>index.js</code> file:</p>
<p class="info">
NOTE: as an exercise, after this update to support async/await, you could go back through the work we've done so far and convert any use of promises to async/await syntax (e.g. the authenticate() function in src/db/models/user.js). It's not required, but could be good practice.
</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/register'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">  presets<span class="token operator">:</span> <span class="token punctuation">[</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">[</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        targets<span class="token operator">:</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">          node<span class="token operator">:</span> <span class="token boolean">true</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">]</span><span class="token punctuation">,</span></mark><br><span class="highlight-line">    <span class="token string">'@babel/preset-react'</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/server/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">index.js - updated @babel/preset-env with target: 'node' for async/await support</p>
<p>Update our new <code>src/server/routes.js</code> file with the following routes:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../db/models'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">  <span class="token punctuation">{</span></span><br><span class="highlight-line">    path<span class="token operator">:</span> <span class="token string">'/signup'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    middleware<span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">      <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token comment">// TODO: validate incoming fields</span></span><br><span class="highlight-line">        <span class="token comment">// TODO: then, check that the user doesn't already exist</span></span><br><span class="highlight-line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          <span class="token comment">// create a new user with the password hash from bcrypt</span></span><br><span class="highlight-line">          <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span></span><br><span class="highlight-line">            Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">              passwordHash<span class="token operator">:</span> User<span class="token punctuation">.</span><span class="token function">generatePasswordHash</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">)</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">          <span class="token comment">// only send back relevant details</span></span><br><span class="highlight-line">          <span class="token keyword">const</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span></span><br><span class="highlight-line">          ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span> <span class="token comment">// created</span></span><br><span class="highlight-line">          ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/json'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token punctuation">{</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span></span><br><span class="highlight-line">          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">            error<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Could not create new user: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></span><br><span class="highlight-line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p class="caption">src/server/routes.js - implemented user registration route</p>
<p>As you can see from the <code>TODO</code> comments, there are a few extras I've left as an exercise for you to work through, but this should get the job done for now. You can test that this route is working with a REST client (e.g. <a href="https://www.postman.com/">Postman</a>) or even <a href="https://curl.haxx.se/">curl</a> from the terminal. The following screenshot shows the result of calling this route initially for creation and then again showing the error that is generated due to the unique email constraint:</p>
<p><img src="/img/2020-04-04-full-stack-javascript-app-pt-4/testing-api-signup.png" alt="Result of posting to api/signup"></p>
<p class="caption">using curl to post to the api/signup route and the user object response</p>
<p>Let's move on to supporting user sign in.</p>
<h4 id="user-sign-in-route">User sign in route <a class="direct-link" href="#user-sign-in-route">#</a></h4>
<p>Here will finally make use of Passport. A user must POST their sign-in credentials (e.g. email address and password), the server will try to find a matching user in the database, and then Passport will check the password. Assuming all goes well, the user will be authenticated and could then gain access to protected areas of our application.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">...</span></span><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">  path<span class="token operator">:</span> <span class="token string">'/signin'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">  method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">  middleware<span class="token operator">:</span> <span class="token punctuation">[</span></mark><br><mark class="highlight-line highlight-line-active">    passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'local'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token comment">// only send back relevant details</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/json'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">]</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span><span class="token punctuation">,</span></mark><br><span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p class="caption">src/server/routes.js - added signin route</p>
<p>The following screenshot shows the result of sending the two supported requests:</p>
<ol>
<li>POST <code>api/signup</code> - new user sign up</li>
<li>POST <code>api/signin</code> - user sign in</li>
</ol>
<p><img src="/img/2020-04-04-full-stack-javascript-app-pt-4/testing-api-signin.png" alt="Result of signing in"></p>
<p class="caption">using curl to sign in and the returned user details</p>
<p>the <code>passport.authenticate()</code> middleware will authenticate a user and, if successul, place the user into the <code>ctx.state.user</code> and then move on to the next middleware in the chain. If authentication is unsuccessful, the server will respond with status code 401 unauthorized, which can then be dealt with on the client accordingly.</p>
<h4 id="user-profile-details-route">User profile details route <a class="direct-link" href="#user-profile-details-route">#</a></h4>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">...</span></span><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">  path<span class="token operator">:</span> <span class="token string">'/users/:id'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">  method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">  middleware<span class="token operator">:</span> <span class="token punctuation">[</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token comment">// retrieve only fields that should be returned</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">const</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        id<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        firstName<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        lastName<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        email<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        createdAt<span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">        updatedAt</mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/json'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        user<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email<span class="token punctuation">,</span> createdAt<span class="token punctuation">,</span> updatedAt <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">]</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span></mark><br><span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p class="caption">src/server/routes.js - basic users/:id route implementation</p>
<p>The following screenshot shows the result of sending the now three supported requests:</p>
<ol>
<li>POST <code>api/signup</code> - new user sign up</li>
<li>POST <code>api/signin</code> - user sign in</li>
<li>GET <code>api/users/:id</code> - view user details</li>
</ol>
<p><img src="/img/2020-04-04-full-stack-javascript-app-pt-4/testing-api-details.png" alt="Result of requesting user details"></p>
<p class="caption">using curl to sign up, sign in, and request user details</p>
<p>The problem at the moment is that any account details can be viewed (if you provide a valid user id). We only want to display user details if a user is signed in and the request is for their own details, no other user details should be returned.</p>
<h3 id="update-protected-client-routes">Update protected client routes <a class="direct-link" href="#update-protected-client-routes">#</a></h3>
<p>Profile route should not be accessible unless a user is authenticated and request is for their user details (i.e. can't see the details of someone else's account). Create a new <code>requireAuth</code> middleware in the api routes file to provide an easy way of requiring authentication for desired routes:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../db/models'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">import</span> passport <span class="token keyword">from</span> <span class="token string">'koa-passport'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active"><span class="token keyword">const</span> <span class="token function-variable function">requireAuth</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>isAuthenticated <span class="token operator">||</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Unauthorized'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span><span class="token punctuation">;</span></mark><br><span class="highlight-line"><span class="token operator">...</span></span></code></pre>
<p class="caption">src/server/routes.js - added requireAuth middleware</p>
<p>With this new middleware, we can easily add protection to any desired routes by placing it ahead of any route-specific middleware. For our purposes, we will protect the user details route with this new middleware:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">    path<span class="token operator">:</span> <span class="token string">'/users/:id'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    middleware<span class="token operator">:</span> <span class="token punctuation">[</span></span><br><mark class="highlight-line highlight-line-active">      requireAuth<span class="token punctuation">,</span></mark><br><span class="highlight-line">      <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          id<span class="token punctuation">,</span></span><br><span class="highlight-line">          firstName<span class="token punctuation">,</span></span><br><span class="highlight-line">          lastName<span class="token punctuation">,</span></span><br><span class="highlight-line">          email<span class="token punctuation">,</span></span><br><span class="highlight-line">          createdAt<span class="token punctuation">,</span></span><br><span class="highlight-line">          updatedAt</span><br><span class="highlight-line">        <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/json'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">          user<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email<span class="token punctuation">,</span> createdAt<span class="token punctuation">,</span> updatedAt <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span></code></pre>
<p class="caption">src/server/routes.js - protected users/:id route with requireAuth</p>
<p>Now that we can affirm a user will only see the result if they are authenticated, we need to put a further user match restriction on the requst:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  path<span class="token operator">:</span> <span class="token string">'/users/:id'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  middleware<span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    requireAuth<span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">      <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">===</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><span class="highlight-line">        <span class="token keyword">const</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          id<span class="token punctuation">,</span></span><br><span class="highlight-line">          firstName<span class="token punctuation">,</span></span><br><span class="highlight-line">          lastName<span class="token punctuation">,</span></span><br><span class="highlight-line">          email<span class="token punctuation">,</span></span><br><span class="highlight-line">          createdAt<span class="token punctuation">,</span></span><br><span class="highlight-line">          updatedAt</span><br><span class="highlight-line">        <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">// ok</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'application/json'</span><span class="token punctuation">;</span></span><br><span class="highlight-line">        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">          user<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> email<span class="token punctuation">,</span> createdAt<span class="token punctuation">,</span> updatedAt <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Not found.'</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      <span class="token punctuation">}</span></mark><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p class="caption">src/server/routes.js - check for user match in users/:id route</p>
<p>The following final screenshot demonstrates both an authenticated and matched user details request as well as an authenticated but unmatched user details request.</p>
<p><img src="/img/2020-04-04-full-stack-javascript-app-pt-4/testing-api-auth-details.png" alt="Result of requesting authenticatd user details"></p>
<p class="caption">using curl to demonstrate protected user details route</p>
<p class="info">
NOTE: Cookies are required for this exmple to work. Calling curl with the <code>-c &lt;cookie-file&gt;</code> and <code>-b &lt;cookie-file&gt;</code> flags allow for creating cookie files and sending cookie files with the request respectively.
</p>
<h4 id="user-sign-out-route">User sign out route <a class="direct-link" href="#user-sign-out-route">#</a></h4>
<p>The only functionality left to implement is a sign out feature. Thankfully, Passport makes this easy too. Add the <code>signout</code> route to the api routes:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token operator">...</span></span><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">  path<span class="token operator">:</span> <span class="token string">'/signout'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">  method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span></mark><br><mark class="highlight-line highlight-line-active">  middleware<span class="token operator">:</span> <span class="token punctuation">[</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></mark><br><mark class="highlight-line highlight-line-active">      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span> <span class="token comment">// success, no content</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">  <span class="token punctuation">]</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active"><span class="token operator">...</span></mark></code></pre>
<p class="caption">src/server/routes.js - implementing the signout route</p>
<p>The following final screenshot demonstrates both an authenticated and matched user details request as well as an authenticated but unmatched user details request.</p>
<p><img src="/img/2020-04-04-full-stack-javascript-app-pt-4/testing-api-signout.png" alt="Result of requesting a signout"></p>
<p class="caption">using curl to demonstrate the signout route</p>
<h2 id="conclusion">Conclusion <a class="direct-link" href="#conclusion">#</a></h2>
<p>If you made it this far, congratulations! It took a lot of work to get here, even though the libraries we've used did most of the heavy lifting. At this point, we've got a decent backend that's capable of accessing a database and authenticating users.</p>
<h3 id="next-steps">Next steps <a class="direct-link" href="#next-steps">#</a></h3>
<p>The next steps will be putting this new functionality to work on the frontend in our react application. We'll update our application to support all the new api routes we've developed here. When we're done, we'll have a pretty decent little dev application that we can use to practice or demonstrate a large number of use cases. See you in phase 2!</p>


<p class="top">
    <a href="#top">Top</a>
</p>
      </main>
      
      <footer class="page-footer">&copy; Nathan Humphrey <a href="https://nathanhumphrey.ca/feed/feed.xml">RSS</a></footer>

      <!-- Current page: /posts/2020-04-03-full-stack-javascript-app-pt-4-phase2/ -->
    </div>
  </body>
</html>